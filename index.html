<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Lab: Paradox Zero-G</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #ui { position: absolute; top: 20px; left: 20px; color: #00ffcc; pointer-events: none; z-index: 10; }
        .card { background: rgba(0, 10, 20, 0.85); padding: 20px; border: 1px solid #00ffcc; border-radius: 8px; box-shadow: 0 0 20px rgba(0,255,204,0.4); }
        #crosshair { position: absolute; top: 50%; left: 50%; width: 8px; height: 8px; border: 1px solid #fff; border-radius: 50%; transform: translate(-50%, -50%); }
        #msg-box { position: absolute; bottom: 10%; width: 100%; text-align: center; color: #fff; font-size: 1.4em; text-shadow: 0 0 10px #000; display: none; background: rgba(0,0,0,0.5); padding: 10px 0; }
        #warning { color: #ff3333; font-weight: bold; display: none; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; color: #00ffcc; display: flex; justify-content: center; align-items: center; z-index: 100; font-size: 1.5em; }
    </style>
</head>
<body>

    <div id="loading">INICIALIZANDO NÚCLEO CUÁNTICO...</div>

    <div id="ui">
        <div class="card">
            <h2 style="margin:0; letter-spacing: 2px;">PROYECTO: SCHRÖDINGER</h2>
            <p id="objective">Objetivo: Localiza al Dr. Einstein en el sector norte.</p>
            <p id="warning">⚠️ CAMPO DE GRAVEDAD CERO DETECTADO</p>
            <hr style="border: 0.5px solid #00ffcc; opacity: 0.3;">
            <small>WASD: Mover | ESPACIO/SHIFT: Altitud | E: Interactuar | CLICK: Pantalla Completa</small>
        </div>
    </div>

    <div id="crosshair"></div>
    <div id="msg-box"></div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com", "three/addons/": "https://unpkg.com" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

        // --- MOTOR Y ESCENA ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x02050a, 0.035);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // --- TEXTURA INDUSTRIAL (Procedural) ---
        const canvas = document.createElement('canvas');
        canvas.width = 512; canvas.height = 512;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#1a1a1a'; ctx.fillRect(0,0,512,512);
        ctx.strokeStyle = '#333'; ctx.lineWidth = 2;
        for(let i=0; i<512; i+=64) { ctx.strokeRect(i, 0, 64, 512); ctx.strokeRect(0, i, 512, 64); }
        const floorTex = new THREE.CanvasTexture(canvas);
        floorTex.wrapS = floorTex.wrapT = THREE.RepeatWrapping;
        floorTex.repeat.set(20, 20);

        // --- ILUMINACIÓN ---
        const ambient = new THREE.AmbientLight(0x4040ff, 0.3);
        scene.add(ambient);

        const flashlight = new THREE.SpotLight(0xffffff, 80, 40, 0.4, 0.5);
        flashlight.castShadow = true;
        camera.add(flashlight);
        flashlight.position.set(0, 0, 0);
        flashlight.target.position.set(0, 0, -1);
        camera.add(flashlight.target);
        scene.add(camera);

        // --- CONSTRUCCIÓN DEL MUNDO ---
        const metalMat = new THREE.MeshStandardMaterial({ map: floorTex, metalness: 0.8, roughness: 0.3 });
        
        // Suelo
        const floor = new THREE.Mesh(new THREE.PlaneGeometry(300, 300), metalMat);
        floor.rotation.x = -Math.PI/2;
        floor.receiveShadow = true;
        scene.add(floor);

        // Paredes Perimetrales
        const createWall = (w, h, d, x, y, z, color = 0x111111) => {
            const wall = new THREE.Mesh(new THREE.BoxGeometry(w, h, d), new THREE.MeshStandardMaterial({ color }));
            wall.position.set(x, y, z);
            wall.castShadow = true;
            wall.receiveShadow = true;
            scene.add(wall);
            return wall;
        };
        createWall(300, 40, 1, 0, 20, -150); // Norte
        createWall(1, 40, 300, -150, 20, 0); // Oeste

        // SALA DE GRAVEDAD CERO
        const zeroGZone = new THREE.Group();
        zeroGZone.position.set(40, 0, -40);
        scene.add(zeroGZone);

        const cage = new THREE.Mesh(new THREE.BoxGeometry(30, 20, 30), new THREE.MeshBasicMaterial({ color: 0x00ffff, wireframe: true, transparent: true, opacity: 0.1 }));
        cage.position.y = 10;
        zeroGZone.add(cage);

        const alarmLight = new THREE.PointLight(0xff0000, 100, 30);
        alarmLight.position.set(0, 15, 0);
        zeroGZone.add(alarmLight);

        // --- ENTIDADES (PNJ y Misión) ---
        const einstein = new THREE.Mesh(new THREE.CapsuleGeometry(0.6, 1.2, 4, 12), new THREE.MeshBasicMaterial({ color: 0x00ffcc, wireframe: true }));
        einstein.position.set(0, 1.5, -20);
        scene.add(einstein);

        const catBox = new THREE.Mesh(new THREE.BoxGeometry(2, 2, 2), new THREE.MeshStandardMaterial({ color: 0x444444, metalness: 1 }));
        catBox.position.set(40, 1, -40); // Dentro de la sala Zero-G
        catBox.castShadow = true;
        scene.add(catBox);

        // --- LÓGICA DE JUEGO ---
        let missionState = 0;
        let isZeroG = false;
        const velocity = new THREE.Vector3();
        const keys = {};
        const controls = new PointerLockControls(camera, document.body);

        document.addEventListener('click', () => controls.lock());
        document.addEventListener('keydown', (e) => { keys[e.code] = true; if(e.code === 'KeyE') checkAction(); });
        document.addEventListener('keyup', (e) => keys[e.code] = false);

        function checkAction() {
            if(camera.position.distanceTo(einstein.position) < 5 && missionState === 0) {
                missionState = 1;
                document.getElementById('objective').innerText = "Objetivo: Entra en la Cámara Zero-G y abre la caja.";
                notify("EINSTEIN: 'El gato está en la cámara de vacío. Ten cuidado, la gravedad es inestable.'");
            }
            if(camera.position.distanceTo(catBox.position) < 4 && missionState === 1) {
                missionState = 2;
                catBox.material.color.set(0x00ff00);
                document.getElementById('objective').innerText = "ESTADO: Paradoja Resuelta.";
                notify("¡HAS ENCONTRADO AL GATO! Está vivo y el experimento ha colapsado con éxito.");
            }
        }

        function notify(t) {
            const b = document.getElementById('msg-box');
            b.innerText = t; b.style.display = 'block';
            setTimeout(() => b.style.display = 'none', 5000);
        }

        // --- ANIMACIÓN ---
        function animate() {
            requestAnimationFrame(animate);
            
            // Check Gravedad Cero
            const playerInZone = camera.position.x > 25 && camera.position.x < 55 && camera.position.z < -25 && camera.position.z > -55;
            isZeroG = playerInZone;
            document.getElementById('warning').style.display = isZeroG ? 'block' : 'none';

            if (controls.isLocked) {
                const accel = 0.04;
                const friction = 0.94;

                if(keys['KeyW']) velocity.z -= accel;
                if(keys['KeyS']) velocity.z += accel;
                if(keys['KeyA']) velocity.x -= accel;
                if(keys['KeyD']) velocity.x += accel;
                
                if(isZeroG) {
                    if(keys['Space']) velocity.y += accel;
                    if(keys['ShiftLeft']) velocity.y -= accel;
                } else {
                    // Gravedad Normal (caída)
                    if(camera.position.y > 1.8) velocity.y -= 0.02;
                    else { camera.position.y = 1.8; velocity.y = 0; }
                }

                velocity.multiplyScalar(friction);
                controls.moveForward(-velocity.z);
                controls.moveRight(velocity.x);
                camera.position.y += velocity.y;
            }

            // Animaciones Visuales
            einstein.rotation.y += 0.03;
            alarmLight.intensity = Math.abs(Math.sin(Date.now() * 0.005)) * 150;
            if(missionState === 2) catBox.rotation.y += 0.05;

            renderer.render(scene, camera);
        }

        // Quitar pantalla de carga
        window.onload = () => document.getElementById('loading').style.display = 'none';
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
